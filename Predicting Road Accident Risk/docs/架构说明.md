# 架构说明

## 设计原则

本项目采用**单一职责原则**，将训练/预测功能和HTTP服务分离：

- `road_accident_risk.py` - 训练和预测脚本
- `api_server.py` - HTTP服务脚本（生产环境）

## 为什么分离？

### 1. 职责清晰
- **训练脚本**: 专注于模型训练和离线预测
- **API服务**: 专注于在线预测服务

### 2. 生产环境优势

**安全性:**
- 生产环境不需要训练能力
- 减少攻击面
- 更小的容器镜像

**资源优化:**
- API服务不需要训练相关依赖
- 更快的启动时间
- 更小的内存占用

**部署灵活性:**
- 训练和API服务可以独立部署
- 可以分别扩展
- 可以分别更新

### 3. 代码维护
- 更清晰的代码结构
- 更容易测试
- 更容易理解

## 文件说明

### road_accident_risk.py
**功能:**
- 模型训练
- 模型保存
- 离线预测（单次/批量）

**使用场景:**
- 开发环境
- 训练环境
- 离线批处理

**依赖:**
- pytabkit
- pandas, numpy, scikit-learn
- torch (训练需要)

### api_server.py
**功能:**
- HTTP API服务
- 在线预测
- 健康检查

**使用场景:**
- 生产环境
- 在线服务
- Docker容器

**依赖:**
- road_accident_risk (导入模型加载和预测功能)
- flask (HTTP服务)
- 模型文件

## 部署架构

### 开发/训练环境
```
road_accident_risk.py → 训练 → 保存模型
```

### 生产环境
```
api_server.py → 加载模型 → 提供HTTP服务
```

### Docker部署
```
Dockerfile.api → 包含 road_accident_risk.py + api_server.py
                → 只启动 api_server.py
                → 不包含训练相关代码（可选）
```

## 使用示例

### 训练模型
```bash
python road_accident_risk.py \
    --data-dir ./playground-series-s5e10 \
    --output-dir ./output
```

### 离线预测
```bash
python road_accident_risk.py \
    --mode predict \
    --model-dir ./output/models \
    --input data.json
```

### 启动API服务
```bash
python api_server.py \
    --model-dir ./output/models \
    --port 5000
```

### Docker部署API服务
```bash
docker-compose -f docker-compose.api.yml up -d
```

## 未来扩展

### 可能的优化方向

1. **API服务优化**
   - 添加缓存（Redis）
   - 添加认证（JWT）
   - 添加限流
   - 使用 gunicorn/uwsgi

2. **模型服务化**
   - 模型版本管理
   - A/B测试
   - 灰度发布

3. **监控和日志**
   - Prometheus指标
   - 结构化日志
   - 分布式追踪

4. **高可用**
   - 多实例部署
   - 负载均衡
   - 健康检查

## 总结

通过分离训练脚本和API服务，我们获得了：
- ✅ 更清晰的职责划分
- ✅ 更好的安全性
- ✅ 更灵活的部署
- ✅ 更容易的维护

这是生产环境部署的最佳实践。

