# Road Accident Risk Prediction 技术方案详细分析

## 🎯 解决的问题

### 道路事故风险预测（Road Accident Risk Prediction）

**问题本质**：这是一个**回归预测任务**，需要根据道路和环境的特征，预测道路事故风险（accident_risk）的数值。

**具体任务**：
- **输入**：道路特征（道路类型、车道数、曲率、限速等）和环境特征（照明、天气、时间等）
- **输出**：事故风险值（0-1 之间的连续数值）

**挑战性**：
1. **特征工程**：需要从原始特征中提取有效信息
2. **模型选择**：需要选择合适的模型处理表格数据
3. **泛化能力**：模型需要在未见过的数据上表现良好
4. **评估指标**：使用 RMSE（Root Mean Squared Error）作为评估指标

**数据特征**：
- 训练集：517,754 条记录
- 测试集：172,585 条记录
- 12 个基础特征 + 目标变量

## 🏗️ 解决方案架构

该方案使用 **TabM (Tabular Model)** 深度学习模型来解决道路事故风险预测问题，核心思路是：
1. 特征工程：从原始数据中提取有效特征
2. 使用 TabM 模型进行训练
3. 5 折交叉验证确保模型稳定性
4. 集成多个折的预测结果

## 📋 完整流程步骤

### 阶段 1: 数据加载与探索

#### 步骤 1.1: 数据加载
**代码位置**：Cell 3

**做了什么**：
- 加载训练数据（`train.csv`）
- 加载测试数据（`test.csv`）
- 加载原始数据（`synthetic_road_accidents_100k.csv`，可选）

**使用的技术**：
- Pandas 数据读取
- CSV 文件解析

**数据格式**：
```python
train.columns = ['id', 'road_type', 'num_lanes', 'curvature', 'speed_limit', 
                 'lighting', 'weather', 'road_signs_present', 'public_road', 
                 'time_of_day', 'holiday', 'school_season', 
                 'num_reported_accidents', 'accident_risk']
```

#### 步骤 1.2: 特征定义
**代码位置**：Cell 4

**做了什么**：
- 定义目标变量：`accident_risk`
- 定义基础特征：12 个原始特征
- 定义分类特征：8 个分类变量

**使用的技术**：
- 特征分类（数值特征 vs 分类特征）

**特征列表**：
- **基础特征（BASE）**：12 个
  - 数值特征：`num_lanes`, `curvature`, `speed_limit`, `num_reported_accidents`
  - 分类特征：`road_type`, `lighting`, `weather`, `road_signs_present`, `public_road`, `time_of_day`, `holiday`, `school_season`

### 阶段 2: 特征工程

#### 步骤 2.1: 基于原始数据的特征（Orig Features）
**代码位置**：Cell 5

**做了什么**：
- 从原始数据集中，对每个基础特征计算目标变量的均值
- 将这些均值作为新特征合并到训练集和测试集
- 创建 12 个 `orig_*` 特征

**使用的技术**：
- **GroupBy 聚合**：`orig.groupby(col)[TARGET].mean()`
- **特征合并**：`pd.merge()`
- **目标编码（Target Encoding）**：使用目标变量的统计信息作为特征

**为什么有效**：
- 利用原始数据中的目标变量信息
- 提供每个特征值对应的平均风险水平
- 帮助模型理解特征与目标的关系

**示例**：
```python
# 对于 road_type='urban'，计算原始数据中所有 urban 道路的平均事故风险
orig_road_type = orig.groupby('road_type')['accident_risk'].mean()
# 结果：{'urban': 0.25, 'rural': 0.35, ...}
# 将这个值作为新特征添加到训练集和测试集
```

#### 步骤 2.2: 元特征（Meta Features）
**代码位置**：Cell 6

**做了什么**：
- 创建一个综合风险评分特征 `Meta`
- 基于领域知识组合多个特征
- 使用加权线性组合

**使用的技术**：
- **特征组合**：多个特征的线性组合
- **领域知识**：基于对事故风险因素的理解

**Meta 特征公式**：
```python
Meta = 0.3 * curvature +                    # 曲率权重 30%
       0.2 * (lighting == "night") +        # 夜间照明权重 20%
       0.1 * (weather != "clear") +         # 恶劣天气权重 10%
       0.2 * (speed_limit >= 60) +         # 高速权重 20%
       0.1 * (num_reported_accidents > 2)  # 历史事故权重 10%
```

**为什么有效**：
- 结合多个风险因素
- 提供综合风险评分
- 帮助模型理解特征间的交互

#### 步骤 2.3: 缺失值处理
**代码位置**：Cell 7

**做了什么**：
- 处理 `orig_curvature` 特征的缺失值
- 使用原始数据的目标变量均值填充

**使用的技术**：
- **缺失值填充**：`fillna()`
- **统计值填充**：使用均值

### 阶段 3: 特征整合

#### 步骤 3.1: 特征列表构建
**代码位置**：Cell 8

**做了什么**：
- 整合所有特征：BASE + ORIG + META
- 最终特征数量：12 + 12 + 1 = 25 个特征

**特征组成**：
- **BASE**：12 个原始特征
- **ORIG**：12 个基于原始数据的特征
- **META**：1 个元特征

### 阶段 4: 模型准备

#### 步骤 4.1: 交叉验证设置
**代码位置**：Cell 10

**做了什么**：
- 设置 5 折交叉验证（K-Fold）
- 随机打乱数据
- 固定随机种子确保可复现

**使用的技术**：
- **K-Fold 交叉验证**：`sklearn.model_selection.KFold`
- **随机种子**：`random_state=42`

**为什么使用交叉验证**：
- 评估模型性能
- 减少过拟合风险
- 提供更可靠的性能估计

#### 步骤 4.2: 模型参数配置
**代码位置**：Cell 13

**做了什么**：
- 配置 TabM 模型的超参数
- 使用经过优化的超参数集

**使用的技术**：
- **超参数优化**：通过实验找到最佳参数组合

**关键参数**：
```python
params = {
    'batch_size': 'auto',                    # 自动批次大小
    'patience': 16,                          # 早停耐心值
    'allow_amp': False,                       # 不使用混合精度
    'arch_type': 'tabm-mini',                # 模型架构：TabM Mini
    'tabm_k': 32,                            # TabM 的 k 参数
    'gradient_clipping_norm': 1.0,           # 梯度裁剪
    'share_training_batches': False,         # 不共享训练批次
    'lr': 0.000624068703424289,              # 学习率
    'weight_decay': 0.0019090968357478807,   # 权重衰减
    'n_blocks': 5,                           # 块数量
    'd_block': 432,                          # 块维度
    'dropout': 0.0,                          # Dropout（不使用）
    'num_emb_type': 'pwl',                   # 数值嵌入类型：分段线性
    'd_embedding': 24,                       # 嵌入维度
    'num_emb_n_bins': 112,                   # 数值嵌入分箱数
}
```

### 阶段 5: 模型训练

#### 步骤 5.1: 交叉验证训练
**代码位置**：Cell 15

**做了什么**：
- 对每个折（fold）进行训练
- 使用 TabM_D_Regressor 模型
- 计算每个折的 RMSE
- 对测试集进行预测并平均

**使用的技术**：
- **TabM (Tabular Model)**：专门用于表格数据的深度学习模型
- **5 折交叉验证**：训练 5 个模型
- **模型集成**：平均多个模型的预测结果

**训练流程**：
```
For each fold (1 to 5):
  1. 分割训练集和验证集
  2. 创建 TabM 模型
  3. 在训练集上训练模型
  4. 在验证集上预测（OOF predictions）
  5. 在测试集上预测
  6. 计算验证集 RMSE

最终：
  - OOF 预测：所有验证集预测的组合
  - 测试集预测：5 个模型预测的平均值
```

**TabM 模型特点**：
- **专门为表格数据设计**：处理混合类型特征（数值+分类）
- **深度学习架构**：使用 Transformer 风格的注意力机制
- **数值嵌入**：将数值特征转换为嵌入向量
- **分类嵌入**：将分类特征转换为嵌入向量
- **特征交互**：自动学习特征间的交互关系

#### 步骤 5.2: 模型评估
**代码位置**：Cell 15

**做了什么**：
- 计算每个折的 RMSE
- 计算整体 OOF RMSE
- 输出性能指标

**评估指标**：
- **RMSE (Root Mean Squared Error)**：均方根误差
  - 公式：`RMSE = sqrt(mean((y_true - y_pred)^2))`
  - 值越小越好

**典型结果**：
```
Fold 1 RMSE: 0.05606
Fold 2 RMSE: 0.05589
Fold 3 RMSE: 0.05598
Fold 4 RMSE: 0.05582
Fold 5 RMSE: 0.05574
Overall OOF RMSE: 0.05590
```

### 阶段 6: 结果保存

#### 步骤 6.1: 生成预测文件
**代码位置**：Cell 16

**做了什么**：
- 保存 OOF 预测结果（用于模型验证）
- 保存测试集预测结果（用于提交）

**使用的技术**：
- Pandas DataFrame 保存
- CSV 文件写入

## 🔧 核心技术总结

### 1. TabM (Tabular Model)
- **专门为表格数据设计**的深度学习模型
- **混合特征处理**：同时处理数值和分类特征
- **注意力机制**：学习特征间的交互关系
- **嵌入层**：将特征转换为向量表示

### 2. 特征工程
- **目标编码（Target Encoding）**：使用原始数据的统计信息
- **元特征（Meta Features）**：基于领域知识的特征组合
- **特征融合**：BASE + ORIG + META

### 3. 模型训练策略
- **交叉验证**：5 折 K-Fold
- **模型集成**：平均多个模型的预测
- **早停机制**：防止过拟合

### 4. 超参数优化
- **学习率**：0.000624
- **权重衰减**：0.001909
- **模型架构**：TabM Mini（5 个块，每块 432 维）
- **数值嵌入**：分段线性（PWL），112 个分箱

## 📊 完整流程图

```
1. 数据加载
   └─> 加载 train.csv, test.csv, orig.csv

2. 特征定义
   └─> BASE (12) + CATS (8)

3. 特征工程
   ├─> Orig Features (12): 基于原始数据的目标编码
   └─> Meta Feature (1): 综合风险评分

4. 特征整合
   └─> FEATURES = BASE + ORIG + META (25 个特征)

5. 交叉验证设置
   └─> 5 折 K-Fold

6. 模型训练（每个折）
   ├─> 创建 TabM 模型
   ├─> 训练模型
   ├─> 验证集预测（OOF）
   └─> 测试集预测

7. 结果集成
   ├─> OOF 预测：所有验证集预测
   └─> 测试集预测：5 个模型预测的平均

8. 保存结果
   ├─> OOF 预测文件
   └─> 测试集预测文件
```

## 🎓 关键创新点

1. **目标编码特征**：利用原始数据中的目标变量信息创建新特征

2. **元特征工程**：基于领域知识创建综合风险评分

3. **TabM 模型**：使用专门为表格数据设计的深度学习模型

4. **模型集成**：通过交叉验证和模型平均提高预测稳定性

5. **超参数优化**：使用经过精心调优的超参数

## 📈 性能优化

- **特征工程**：通过目标编码和元特征提高模型性能
- **模型选择**：TabM 专门为表格数据优化
- **交叉验证**：确保模型泛化能力
- **模型集成**：平均多个模型的预测，减少方差

## 🔍 技术细节

### TabM 模型架构

**TabM (Tabular Model)** 是一个专门为表格数据设计的深度学习模型：

1. **输入层**：
   - 数值特征 → 数值嵌入（PWL，分段线性）
   - 分类特征 → 分类嵌入

2. **特征交互层**：
   - 使用注意力机制学习特征间交互
   - 多个 Transformer 风格的块

3. **输出层**：
   - 回归输出（连续值）

### 数值嵌入（PWL）

**分段线性（Piecewise Linear）嵌入**：
- 将连续数值特征分成多个区间（bins）
- 每个区间学习一个嵌入向量
- 通过线性插值计算最终嵌入

**优势**：
- 更好地处理非线性关系
- 减少数值特征的维度

### 目标编码（Target Encoding）

**原理**：
- 使用目标变量的统计信息（如均值）作为特征
- 对每个特征值，计算其在原始数据中对应的平均目标值

**优势**：
- 利用目标变量的信息
- 提供特征与目标的关系强度
- 特别适合分类特征

**风险**：
- 可能导致过拟合（如果使用训练集的目标变量）
- 解决方案：使用外部数据集（原始数据）进行编码

## 📊 数据流

```
原始数据 (train.csv)
    ↓
特征工程
    ├─> BASE Features (12)
    ├─> Orig Features (12) ← 来自原始数据集
    └─> Meta Feature (1)
    ↓
最终特征 (25)
    ↓
TabM 模型
    ├─> 数值嵌入
    ├─> 分类嵌入
    ├─> 特征交互
    └─> 回归输出
    ↓
预测结果
    ├─> OOF Predictions
    └─> Test Predictions
```

## 🎯 模型优势

1. **专门设计**：TabM 专门为表格数据优化，比通用模型更适合
2. **特征交互**：自动学习特征间的复杂交互关系
3. **混合特征**：同时处理数值和分类特征
4. **可解释性**：通过注意力机制可以理解特征重要性
5. **性能优秀**：在多个表格数据任务上表现优异

## 📝 总结

这个方案通过：
1. **精心设计的特征工程**（目标编码 + 元特征）
2. **专门优化的模型**（TabM）
3. **稳健的训练策略**（交叉验证 + 模型集成）

成功解决了道路事故风险预测问题，在 Kaggle 竞赛中取得了优异的成绩（OOF RMSE: 0.05590）。

