# å¦‚ä½•ç†è§£ ARC Prize 2024 è§£å†³æ–¹æ¡ˆä»£ç 

## ğŸ¯ æ ¸å¿ƒæ€è·¯

è¿™ä¸ªè§£å†³æ–¹æ¡ˆä½¿ç”¨**å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰**æ¥è§£å†³ ARC æŒ‘æˆ˜ã€‚åŸºæœ¬æ€è·¯æ˜¯ï¼š
1. å°† ARC ä»»åŠ¡è½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼
2. ä½¿ç”¨ LLM ç”Ÿæˆå€™é€‰ç­”æ¡ˆ
3. é€šè¿‡è¯„åˆ†ç®—æ³•é€‰æ‹©æœ€ä½³ç­”æ¡ˆ

## ğŸ“š å­¦ä¹ è·¯å¾„

### ç¬¬ä¸€æ­¥ï¼šç†è§£æ•°æ®æ ¼å¼

**ARC ä»»åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ**
- è¾“å…¥ï¼šå‡ ä¸ªç¤ºä¾‹ï¼ˆè¾“å…¥ç½‘æ ¼ â†’ è¾“å‡ºç½‘æ ¼ï¼‰
- è¾“å‡ºï¼šå¯¹æ–°è¾“å…¥ç½‘æ ¼çš„é¢„æµ‹

**æ•°æ®å¦‚ä½•å­˜å‚¨ï¼Ÿ**
```python
# æŸ¥çœ‹æ•°æ®æ–‡ä»¶
import json
with open('./arc-prize-2024/arc-agi_test_challenges.json') as f:
    data = json.load(f)
    
# æ•°æ®æ ¼å¼ï¼š
# {
#   "task_id": {
#     "train": [{"input": [[...]], "output": [[...]]}, ...],
#     "test": [{"input": [[...]]}, ...]
#   }
# }
```

### ç¬¬äºŒæ­¥ï¼šç†è§£æ•°æ®è½¬æ¢

**`ArcFormatter` çš„ä½œç”¨**ï¼š
- å°†ç½‘æ ¼è½¬æ¢ä¸ºæ–‡æœ¬å­—ç¬¦ä¸²
- ä¾‹å¦‚ï¼š`[[0,1],[1,0]]` â†’ `"0 1\n1 0"`
- æ·»åŠ ç‰¹æ®Šæ ‡è®°ï¼š`I` (Input), `O` (Output)

**æŸ¥çœ‹æ ¼å¼åŒ–ç¤ºä¾‹**ï¼š
```python
from arc_loader import ArcFormatter_premix_3
from transformers import AutoTokenizer

tokenizer = AutoTokenizer.from_pretrained('gpt2')  # ç¤ºä¾‹
formatter = ArcFormatter_premix_3(tokenizer=tokenizer)

# æ ¼å¼åŒ–ä¸€ä¸ªä»»åŠ¡
task_text = formatter.format_task(task_data)
print(task_text)
```

### ç¬¬ä¸‰æ­¥ï¼šç†è§£è®­ç»ƒè¿‡ç¨‹

**ä¸ºä»€ä¹ˆéœ€è¦è®­ç»ƒï¼Ÿ**
- åŸºç¡€æ¨¡å‹ä¸ç†è§£ ARC ä»»åŠ¡æ ¼å¼
- é€šè¿‡å¾®è°ƒï¼ˆfine-tuningï¼‰è®©æ¨¡å‹å­¦ä¼šç”Ÿæˆ ARC ç­”æ¡ˆ

**è®­ç»ƒæµç¨‹**ï¼š
1. åŠ è½½é¢„è®­ç»ƒæ¨¡å‹ï¼ˆå¦‚ `wb55l_nemomini_fulleval`ï¼‰
2. æ·»åŠ  LoRA é€‚é…å™¨ï¼ˆåªè®­ç»ƒå°‘é‡å‚æ•°ï¼‰
3. ä½¿ç”¨è®­ç»ƒæ•°æ®å¾®è°ƒæ¨¡å‹
4. ä¿å­˜è®­ç»ƒå¥½çš„æ¨¡å‹

**å…³é”®ä»£ç **ï¼š
```python
# åœ¨ common_stuff.py ä¸­
def start_training(gpu):
    model, formatter = prepare_run(base_model, train=True, gpu=gpu)
    dataset = prepare_dataset(formatter, train=True, gpu=gpu)
    training_run(model, formatter, dataset, ...)
```

### ç¬¬å››æ­¥ï¼šç†è§£æ¨ç†è¿‡ç¨‹

**æ¨ç†æµç¨‹**ï¼š
1. åŠ è½½è®­ç»ƒå¥½çš„æ¨¡å‹
2. å¯¹æ¯ä¸ªæµ‹è¯•ä»»åŠ¡ï¼š
   - æ ¼å¼åŒ–è¾“å…¥
   - ä½¿ç”¨æ¨¡å‹ç”Ÿæˆå€™é€‰ç­”æ¡ˆ
   - è¯„åˆ†å’Œé€‰æ‹©æœ€ä½³ç­”æ¡ˆ

**ç”Ÿæˆç­–ç•¥**ï¼š
- **Turbo DFS**: æ·±åº¦ä¼˜å…ˆæœç´¢ç”Ÿæˆå¤šä¸ªå€™é€‰
- **æœ€å°æ¦‚ç‡é˜ˆå€¼**: è¿‡æ»¤ä½è´¨é‡ç­”æ¡ˆ
- **å¤šçŒœæµ‹**: æ¯ä¸ªä»»åŠ¡ç”Ÿæˆå¤šä¸ªå€™é€‰ç­”æ¡ˆ

**å…³é”®ä»£ç **ï¼š
```python
# åœ¨ model_runner.py ä¸­
def inference_run_v2(model, formatter, dataset, decoder, ...):
    # å¯¹æ¯ä¸ªä»»åŠ¡ç”Ÿæˆå€™é€‰ç­”æ¡ˆ
    # ä½¿ç”¨ decoder è§£ç å’Œè¯„åˆ†
```

### ç¬¬äº”æ­¥ï¼šç†è§£ç­”æ¡ˆé€‰æ‹©

**ä¸ºä»€ä¹ˆéœ€è¦é€‰æ‹©ç®—æ³•ï¼Ÿ**
- æ¨¡å‹å¯èƒ½ç”Ÿæˆå¤šä¸ªå€™é€‰ç­”æ¡ˆ
- éœ€è¦é€‰æ‹©æœ€å¯èƒ½æ­£ç¡®çš„ç­”æ¡ˆ

**è¯„åˆ†æœºåˆ¶**ï¼š
1. **æ¨ç†åˆ†æ•°**: æ¨¡å‹ç”Ÿæˆç­”æ¡ˆçš„å¯¹æ•°æ¦‚ç‡
2. **å¢å¼ºåˆ†æ•°**: å¯¹ç­”æ¡ˆè¿›è¡Œå˜æ¢ï¼ˆæ—‹è½¬ã€è½¬ç½®ç­‰ï¼‰åçš„å¹³å‡åˆ†æ•°
3. **æœ€ç»ˆåˆ†æ•°**: `inf_score + aug_score`

**é€‰æ‹©ç®—æ³•**ï¼š
- `score_full_probmul_3`: åŸºäºæ¦‚ç‡ä¹˜ç§¯ï¼ˆæ¨èï¼‰
- `score_all_probsum`: åŸºäºæ¦‚ç‡å’Œ

## ğŸ” ä»£ç é˜…è¯»æŠ€å·§

### 1. ä»å…¥å£å¼€å§‹

**æ¨èé˜…è¯»é¡ºåº**ï¼š
1. `common_stuff.py` - é…ç½®å’Œä¸»å‡½æ•°
2. `arc_loader.py` - æ•°æ®åŠ è½½å’Œæ ¼å¼åŒ–
3. `model_runner.py` - æ¨¡å‹è®­ç»ƒå’Œæ¨ç†
4. `selection.py` - ç­”æ¡ˆé€‰æ‹©ç®—æ³•

### 2. ç†è§£å‡½æ•°è°ƒç”¨é“¾

**è®­ç»ƒæµç¨‹**ï¼š
```
start_training()
  â†’ prepare_run()          # å‡†å¤‡æ¨¡å‹
  â†’ prepare_dataset()      # å‡†å¤‡æ•°æ®
  â†’ training_run()          # æ‰§è¡Œè®­ç»ƒ
```

**æ¨ç†æµç¨‹**ï¼š
```
start_inference()
  â†’ prepare_run()          # åŠ è½½æ¨¡å‹
  â†’ prepare_dataset()      # å‡†å¤‡æ•°æ®
  â†’ inference_run_v2()     # æ‰§è¡Œæ¨ç†
    â†’ inference_step()     # å•æ­¥æ¨ç†
    â†’ process_inference_output()  # å¤„ç†è¾“å‡º
  â†’ calc_augmented_scores()  # å¢å¼ºè¯„åˆ†
  â†’ run_selection_algo()   # é€‰æ‹©ç­”æ¡ˆ
```

### 3. å…³æ³¨å…³é”®å‚æ•°

**è®­ç»ƒå‚æ•°**ï¼š
- `max_seq_length_train = 4224`: è®­ç»ƒåºåˆ—æœ€å¤§é•¿åº¦
- `train_epochs = 4`: è®­ç»ƒè½®æ•°
- `learning_rate = 1e-4`: å­¦ä¹ ç‡

**æ¨ç†å‚æ•°**ï¼š
- `max_seq_length_infer = 8192`: æ¨ç†åºåˆ—æœ€å¤§é•¿åº¦
- `min_prob = 0.17`: æœ€å°æ¦‚ç‡é˜ˆå€¼
- `n_guesses = 2`: æ¯ä¸ªä»»åŠ¡ç”Ÿæˆ2ä¸ªå€™é€‰ç­”æ¡ˆ

### 4. è°ƒè¯•æŠ€å·§

**æ·»åŠ æ‰“å°è¯­å¥**ï¼š
```python
# åœ¨å…³é”®ä½ç½®æ·»åŠ 
print(f"Dataset size: {len(dataset)}")
print(f"Model device: {model.device}")
print(f"Generated tokens: {len(tokens)}")
```

**æ£€æŸ¥ä¸­é—´ç»“æœ**ï¼š
```python
# æŸ¥çœ‹æ ¼å¼åŒ–åçš„æ•°æ®
print(formatter.format_task(task_data)[:500])  # å‰500å­—ç¬¦

# æŸ¥çœ‹ç”Ÿæˆçš„ç­”æ¡ˆ
print(f"Generated: {decoded_output}")
```

## ğŸ“– å…³é”®æ¦‚å¿µè§£é‡Š

### LoRA (Low-Rank Adaptation)
- **ç›®çš„**: é«˜æ•ˆå¾®è°ƒå¤§æ¨¡å‹
- **åŸç†**: åªè®­ç»ƒå°‘é‡å‚æ•°ï¼ˆé€‚é…å™¨ï¼‰ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæ¨¡å‹
- **ä¼˜åŠ¿**: èŠ‚çœå†…å­˜å’Œè®¡ç®—èµ„æº

### 4-bit é‡åŒ–
- **ç›®çš„**: å‡å°‘æ¨¡å‹å†…å­˜å ç”¨
- **åŸç†**: å°†æ¨¡å‹æƒé‡ä» 32-bit é™ä½åˆ° 4-bit
- **ä¼˜åŠ¿**: å¯ä»¥åœ¨è¾ƒå°çš„ GPU ä¸Šè¿è¡Œå¤§æ¨¡å‹

### æ•°æ®å¢å¼º
- **ç›®çš„**: å¢åŠ è®­ç»ƒæ•°æ®å¤šæ ·æ€§
- **æ–¹æ³•**: æ—‹è½¬ã€è½¬ç½®ã€æ’åˆ—ç­‰
- **æ•ˆæœ**: æé«˜æ¨¡å‹æ³›åŒ–èƒ½åŠ›

### å¢å¼ºè¯„åˆ†
- **ç›®çš„**: æé«˜ç­”æ¡ˆé€‰æ‹©çš„å‡†ç¡®æ€§
- **æ–¹æ³•**: å¯¹å€™é€‰ç­”æ¡ˆè¿›è¡Œå˜æ¢ï¼Œè®¡ç®—å¹³å‡åˆ†æ•°
- **åŸç†**: å¦‚æœç­”æ¡ˆæ­£ç¡®ï¼Œå˜æ¢ååº”è¯¥ä»ç„¶æ­£ç¡®

## ğŸ› ï¸ å®è·µå»ºè®®

### 1. å…ˆè¿è¡Œå°è§„æ¨¡æµ‹è¯•
```python
# åœ¨ common_stuff.py ä¸­ä¿®æ”¹
arc_test_set.is_fake = True  # ä½¿ç”¨å‡æ•°æ®æµ‹è¯•
max_steps = 20  # é™åˆ¶è®­ç»ƒæ­¥æ•°
```

### 2. é€æ­¥ç†è§£æ¯ä¸ªæ¨¡å—
- å…ˆç†è§£æ•°æ®åŠ è½½
- å†ç†è§£æ¨¡å‹è®­ç»ƒ
- æœ€åç†è§£æ¨ç†å’Œé€‰æ‹©

### 3. ä¿®æ”¹å‚æ•°è§‚å¯Ÿæ•ˆæœ
- è°ƒæ•´ `min_prob` çœ‹ç­”æ¡ˆè´¨é‡
- è°ƒæ•´ `n_guesses` çœ‹å€™é€‰æ•°é‡
- è°ƒæ•´ `max_seq_length` çœ‹å†…å­˜ä½¿ç”¨

### 4. æŸ¥çœ‹ä¸­é—´æ–‡ä»¶
```python
# è®­ç»ƒåçš„æ¨¡å‹
./temp/finetuned_model_gpu0/

# æ¨ç†è¾“å‡º
./temp/inference_outputs/

# è¯„åˆ†ç»“æœ
./temp/inference_scoring/
```

## ğŸ“š ç›¸å…³èµ„æº

- **ARC æŒ‘æˆ˜**: https://github.com/fchollet/ARC
- **Unsloth**: https://github.com/unslothai/unsloth
- **LoRA è®ºæ–‡**: "LoRA: Low-Rank Adaptation of Large Language Models"
- **Transformers æ–‡æ¡£**: https://huggingface.co/docs/transformers

## â“ å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆéœ€è¦è®­ç»ƒï¼Ÿ**
A: åŸºç¡€æ¨¡å‹ä¸ç†è§£ ARC ä»»åŠ¡æ ¼å¼ï¼Œéœ€è¦é€šè¿‡å¾®è°ƒå­¦ä¹ ã€‚

**Q: ä¸ºä»€ä¹ˆä½¿ç”¨ LoRAï¼Ÿ**
A: å®Œæ•´å¾®è°ƒéœ€è¦å¤§é‡èµ„æºï¼ŒLoRA åªè®­ç»ƒå°‘é‡å‚æ•°ï¼Œæ›´é«˜æ•ˆã€‚

**Q: å¢å¼ºè¯„åˆ†å¦‚ä½•å·¥ä½œï¼Ÿ**
A: å¯¹ç­”æ¡ˆè¿›è¡Œæ—‹è½¬ã€è½¬ç½®ç­‰å˜æ¢ï¼Œå¦‚æœç­”æ¡ˆæ­£ç¡®ï¼Œå˜æ¢ååº”è¯¥ä»ç„¶æ­£ç¡®ã€‚

**Q: å¦‚ä½•æé«˜å‡†ç¡®ç‡ï¼Ÿ**
A: å¢åŠ è®­ç»ƒæ•°æ®ã€è°ƒæ•´è¶…å‚æ•°ã€ä½¿ç”¨æ›´å¤§çš„æ¨¡å‹ã€æ”¹è¿›é€‰æ‹©ç®—æ³•ã€‚

