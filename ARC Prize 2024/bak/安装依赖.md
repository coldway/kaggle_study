# 安装依赖指南

## 问题：ModuleNotFoundError: No module named 'unsloth'

如果遇到这个错误，说明 unsloth 库没有正确安装。

## 解决方案

### 方法 1: 在 Notebook 中安装（推荐）

运行 Cell 7，它会自动安装所有依赖。如果失败，请使用方法 2。

### 方法 2: 在终端中手动安装

#### 步骤 1: 升级 pip
```bash
python3 -m pip install --upgrade pip
```

#### 步骤 2: 安装 PyTorch

**macOS (CPU 版本)**:
```bash
python3 -m pip install torch torchvision torchaudio
```

**Linux/Windows (如果有 CUDA)**:
```bash
# CUDA 11.8
python3 -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# CUDA 12.1
python3 -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
```

#### 步骤 3: 安装其他依赖
```bash
python3 -m pip install numpy tqdm tokenizers transformers datasets accelerate peft trl
```

#### 步骤 4: 安装 Unsloth
```bash
python3 -m pip install unsloth
```

如果上述命令失败，尝试：
```bash
python3 -m pip install "unsloth[colab-new] @ git+https://github.com/unslothai/unsloth.git"
```

### 方法 3: 使用 requirements.txt

创建一个 `requirements.txt` 文件：

```txt
numpy>=1.24.0
tqdm>=4.65.0
tokenizers>=0.13.0
transformers>=4.40.0
datasets>=2.16.0
accelerate>=0.25.0
peft>=0.6.0
trl>=0.7.0
torch>=2.0.0
unsloth
```

然后安装：
```bash
python3 -m pip install -r requirements.txt
```

## 验证安装

运行以下代码验证安装：

```python
# 验证基础库
import numpy as np
import torch
print(f"NumPy: {np.__version__}")
print(f"PyTorch: {torch.__version__}")

# 验证 unsloth
try:
    from unsloth import FastLanguageModel
    print("✓ Unsloth installed successfully")
except ImportError:
    print("✗ Unsloth not installed")

# 验证 transformers
try:
    import transformers
    print(f"✓ Transformers: {transformers.__version__}")
except ImportError:
    print("✗ Transformers not installed")
```

## 常见问题

### 问题 1: pip 版本过旧
**错误**: `WARNING: You are using pip version 21.2.4`

**解决**:
```bash
python3 -m pip install --upgrade pip
```

### 问题 2: 网络超时
**错误**: `ReadTimeoutError` 或 `ConnectionError`

**解决**:
1. 使用国内镜像源：
```bash
python3 -m pip install -i https://pypi.tuna.tsinghua.edu.cn/simple unsloth
```

2. 增加超时时间：
```bash
python3 -m pip install --default-timeout=1000 unsloth
```

### 问题 3: 编译错误（macOS）
**错误**: 编译 unsloth 时出错

**解决**:
1. 安装 Xcode Command Line Tools:
```bash
xcode-select --install
```

2. 使用预编译版本或从源码安装

### 问题 4: CUDA 版本不匹配
**错误**: PyTorch 和 CUDA 版本不匹配

**解决**:
1. 检查 CUDA 版本：
```bash
nvcc --version
```

2. 安装匹配的 PyTorch 版本（见方法 2）

## 完整安装命令（一键安装）

```bash
# 升级 pip
python3 -m pip install --upgrade pip

# 安装基础依赖
python3 -m pip install numpy tqdm tokenizers

# 安装 PyTorch (根据你的系统选择)
# macOS:
python3 -m pip install torch torchvision torchaudio

# Linux with CUDA 12.1:
# python3 -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121

# 安装 Transformers 生态
python3 -m pip install transformers datasets accelerate peft trl

# 安装 Unsloth
python3 -m pip install unsloth
```

## 检查已安装的包

```bash
python3 -m pip list | grep -E "(torch|unsloth|transformers|numpy)"
```

## 如果仍然失败

1. **检查 Python 版本**：需要 Python 3.8+
   ```bash
   python3 --version
   ```

2. **使用虚拟环境**（推荐）：
   ```bash
   python3 -m venv venv
   source venv/bin/activate  # macOS/Linux
   # 或
   venv\Scripts\activate  # Windows
   pip install -r requirements.txt
   ```

3. **查看详细错误信息**：
   ```bash
   python3 -m pip install unsloth -v
   ```

4. **尝试从源码安装**：
   ```bash
   git clone https://github.com/unslothai/unsloth.git
   cd unsloth
   python3 -m pip install -e .
   ```

