# ARC Prize 2024 运行命令

## 准备工作

### 1. 提取 Python 文件

从 notebook 中提取所有 Python 文件：

```bash
cd "/Users/yuanrui/go/src/new/kaggle study/ARC Prize 2024"
python3 extract_python_files.py
```

这将生成以下文件：
- `model_runner.py` - 模型运行相关函数
- `arc_loader.py` - ARC 数据加载器
- `selection.py` - 选择和评分算法
- `async_tools.py` - 异步工具
- `common_stuff.py` - 通用配置

### 2. 检查数据文件

确保数据文件在 `arc-prize-2024` 目录下：

```bash
ls -la arc-prize-2024/
```

应该包含：
- `arc-agi_test_challenges.json`
- `arc-agi_training_solutions.json`
- `arc-agi_training_challenges.json`
- `arc-agi_evaluation_challenges.json`
- `arc-agi_evaluation_solutions.json`
- `sample_submission.json`

### 3. 配置 HuggingFace Token（如果需要）

如果模型需要认证，设置环境变量：

```bash
export HF_TOKEN='your_token_here'
# 或
export HUGGINGFACE_TOKEN='your_token_here'
```

或者使用命令行登录：

```bash
huggingface-cli login
```

## 运行命令

### 查看帮助

```bash
python3 run_arc_solution.py --help
```

### 完整流程（训练 + 推理 + 生成提交）

```bash
python3 run_arc_solution.py --mode full
```

### 仅训练

```bash
python3 run_arc_solution.py --mode train
```

### 仅推理（需要先完成训练）

```bash
python3 run_arc_solution.py --mode inference
```

### 仅生成提交文件（需要先完成推理）

```bash
python3 run_arc_solution.py --mode generate
```

### 指定模型

```bash
python3 run_arc_solution.py --model "microsoft/phi-2" --mode full
```

### 跳过训练（仅推理）

```bash
python3 run_arc_solution.py --skip-training --mode full
```

### 跳过推理（仅训练）

```bash
python3 run_arc_solution.py --skip-inference --mode full
```

### 跳过依赖安装

```bash
python3 run_arc_solution.py --skip-install --mode full
```

## 环境检测

脚本会自动检测本地环境：

- **CUDA 可用**: 使用 GPU 训练，使用量化模型
- **仅 CPU (macOS)**: 使用 CPU 训练，使用标准 transformers 模式
- **数据路径**: 自动检测 `arc-prize-2024` 目录

## 输出文件

运行完成后，将生成：

- `submission.json` - 提交文件
- `temp/finetuned_model_gpu0/` - 训练后的模型
- `temp/inference_outputs/` - 推理输出
- `temp/inference_scoring/` - 评分结果

## 故障排除

### 问题 1: 缺少 Python 文件

```bash
python3 extract_python_files.py
```

### 问题 2: 模型访问错误

检查 HuggingFace token：

```bash
echo $HF_TOKEN
```

如果没有设置，运行：

```bash
export HF_TOKEN='your_token_here'
```

### 问题 3: 内存不足

在 `common_stuff.py` 中调整批次大小：

```python
batch_size = 1  # 减小批次大小
grad_acc = 8   # 增加梯度累积
```

### 问题 4: 数据文件未找到

确保 `arc-prize-2024` 目录存在且包含所有 JSON 文件。

## 示例完整运行流程

```bash
# 1. 提取 Python 文件
python3 extract_python_files.py

# 2. 设置 HuggingFace token（如果需要）
export HF_TOKEN='your_token_here'

# 3. 运行完整流程
python3 run_arc_solution.py --mode full

# 4. 检查结果
cat submission.json
```

## 性能优化建议

### CPU 模式（macOS）

- 使用较小的模型进行测试
- 减小 `max_seq_length_train` 和 `max_seq_length_infer`
- 使用 `batch_size=1` 和较大的 `gradient_accumulation_steps`

### GPU 模式

- 使用量化模型（4-bit）
- 使用多 GPU 训练（如果可用）
- 调整批次大小以充分利用 GPU 内存

